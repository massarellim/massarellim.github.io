<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prebid Video + Google IMA SDK Integration</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1 {
        color: #333;
      }

      #mainContainer {
        position: relative;
        width: 640px;
        height: 480px;
        background-color: #000;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      #videoElement {
        width: 100%;
        height: 100%;
        outline: none;
      }

      #adContainer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* Let clicks pass through to video unless ad is active */
      }

      #playButton {
        margin-top: 20px;
        padding: 12px 24px;
        font-size: 16px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      #playButton:hover {
        background-color: #45a049;
      }

      .log-container {
        margin-top: 20px;
        width: 640px;
        height: 200px;
        background: #fff;
        border: 1px solid #ddd;
        padding: 10px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
        border-radius: 4px;
      }
    </style>

    <script>
      window.__tcfapi = function (command, version, callback, parameter) {
        if (command === "addEventListener" || command === "getTCData") {
          var tcData = {
            addtlConsent: "1~", // Truncated for brevity
            tcString:
              "CQfDEkAQfDEkAAHABBENCQFsAP_gAEPgABCYJ4EBxC5UQAFCACJyAPoAAAQHQEAIQgAgBAYAASABCJIAAAQEgEAQIAAAICAAAAIAMCQAIAAgAAAAAQAAIIAAIAAAAAAQAAAAIAAAAAAAAQAAAEAAAIAAEAAAgEAEAAAAgAAAAAIACEAAAAAAAAAAAAAAAAAFAAAAAAEAAAAAAAAAACgEAAAAQAAAAAAAABAIBAAAAAAEAAAAAAAAAAAABBPCA-AAsACoAFwAOAAeABAACQAGQANAAmQBcAF0APwAhABOACtAGAAOcAdwBCACLAEcAJMAdsA9oCmwFsALzAZOAywCN4E8AAAA.f_wACHwAAAAA",
            eventStatus: "tcloaded",
            cmpStatus: "loaded",
          };
          setTimeout(function () {
            callback(tcData, true);
          }, 0);
        }
      };
    </script>

    <script
      async
      src="//cdn.jsdelivr.net/npm/prebid.js@latest/dist/not-for-prod/prebid.js"
    ></script>

    <script
      type="text/javascript"
      src="//imasdk.googleapis.com/js/sdkloader/ima3.js"
    ></script>

    <script>
      var pbjs = pbjs || {};
      pbjs.que = pbjs.que || [];

      // Define the Video Ad Unit
      var videoAdUnit = {
        code: "video1",
        mediaTypes: {
          video: {
            context: "instream",
            playerSize: [640, 480],
            mimes: ["video/mp4"],
            protocols: [1, 2, 3, 4, 5, 6, 7, 8],
            playbackmethod: [2],
            skip: 1,
          },
        },
        bids: [
          {
            bidder: "appnexus",
            params: {
              placementId: 13232361, // AppNexus test video placement
              video: {
                skippable: true,
                playback_method: ["auto_play_sound_off"],
              },
            },
          },
        ],
      };

      function callPrebid() {
        pbjs.que.push(function () {
          // 1. Add Ad Units
          pbjs.addAdUnits([videoAdUnit]);

          // 2. Set Config
          pbjs.setConfig({
            consentManagement: {
              gdpr: {
                cmpApi: "iab",
                timeout: 500,
                defaultGdprScope: true,
              },
            },
            cache: {
              url: "https://prebid.adnxs.com/pbc/v1/cache",
            },
            debugging: {
                enabled: true, 
                intercept: [{
                  when: {bidder: 'appnexus'}, 
                  then: {cpm: 9.90},
                  options: {delay: 1000}
                },{
                  when: {bidder: 'criteo'}, 
                  then: {cpm: 0.50},
                  options: {delay: 3000}
                }]
              }
          });

          log("Requesting Prebid bids...");

          // 3. Request Bids
          pbjs.requestBids({
            bidsBackHandler: function (bids) {
              log("Bids returned.");

              // 4. Build the VAST URL with DFP module
              var videoUrl = pbjs.adServers.dfp.buildVideoUrl({
                adUnit: videoAdUnit,
                params: {
                  iu: "/6353/massarellim_prebid_video_test",
                  cust_params: {
                    section: "blog",
                    anotherKey: "anotherValue",
                  },
                  output: "vast",
                  vpos: "preroll",
                  pmad: 3,
                  max_ad_duration: 90000,
                },
              });

              // 5. Mark winning bid as used
              pbjs.markWinningBidAsUsed({
                adUnitCode: videoAdUnit.code,
              });

              // 6. Pass the URL to the player function
              log("Generated VAST URL: " + videoUrl);
              invokeVideoPlayer(videoUrl);
            },
          });
        });
      }

      function log(message) {
        console.log(message);
        var logger = document.getElementById("logArea");
        if (logger) {
          logger.innerHTML += message + "<br>";
          logger.scrollTop = logger.scrollHeight;
        } else {
          window.addEventListener("DOMContentLoaded", () => {
            var l = document.getElementById("logArea");
            if (l) {
              l.innerHTML += message + "<br>";
              l.scrollTop = l.scrollHeight;
            }
          });
        }
      }
    </script>
  </head>
  <body>
    <h1>Prebid Video & IMA SDK Demo</h1>

    <div id="mainContainer">
      <video id="videoElement" controls preload="auto">
        <source
          src="https://storage.googleapis.com/gvabox/media/samples/stock.mp4"
          type="video/mp4"
        />
      </video>
      <div id="adContainer"></div>
    </div>

    <button id="playButton">Play Video with Ad</button>

    <div class="log-container" id="logArea"></div>

    <script>
      var videoElement = document.getElementById("videoElement");
      var adContainer = document.getElementById("adContainer");
      var playButton = document.getElementById("playButton");

      var adDisplayContainer;
      var adsLoader;
      var adsManager;

      // User action requests Prebid
      playButton.addEventListener("click", function () {
        log("Play button clicked. Requesting bids...");
        callPrebid();
      });

      function invokeVideoPlayer(prebidVastUrl) {
        // Cleanup if user clicks button multiple times
        if (adsManager) {
          adsManager.destroy();
          adsManager = null;
        }

        // Step A: Create the AdDisplayContainer
        // Re-creating it is generally safe, or you can check if it exists.
        // For simplicity/robustness in a demo, we create a fresh one.
        adDisplayContainer = new google.ima.AdDisplayContainer(
          adContainer,
          videoElement,
        );
        adDisplayContainer.initialize();

        // Step B: Create the AdsLoader
        adsLoader = new google.ima.AdsLoader(adDisplayContainer);

        // Listen for the ADS_MANAGER_LOADED event
        adsLoader.addEventListener(
          google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
          onAdsManagerLoaded,
          false,
        );

        // Listen for errors
        adsLoader.addEventListener(
          google.ima.AdErrorEvent.Type.AD_ERROR,
          onAdError,
          false,
        );

        // Step C: Request Ads
        var adsRequest = new google.ima.AdsRequest();

        if (prebidVastUrl) {
          log("Using Prebid VAST URL");
          adsRequest.adTagUrl = prebidVastUrl;
        } else {
          log("Warning: Prebid URL was empty. Using Google Fallback.");
          adsRequest.adTagUrl =
            "https://pubads.g.doubleclick.net/gampad/ads?iu=/21775744923/external/single_ad_samples&sz=640x480&cust_params=sample_ct%3Dlinear&ciu_szs=300x250%2C728x90&gdfp_req=1&output=vast&vpos=preroll&unviewed_position_start=1&env=vp&pmad=3&max_ad_duration=90000&correlator=";
        }

        adsRequest.linearAdSlotWidth = 640;
        adsRequest.linearAdSlotHeight = 480;
        adsRequest.nonLinearAdSlotWidth = 640;
        adsRequest.nonLinearAdSlotHeight = 150;

        log("Requesting IMA Ads from SDK...");
        adsLoader.requestAds(adsRequest);
      }

      function onAdsManagerLoaded(adsManagerLoadedEvent) {
        log("Ads Manager Loaded.");
        var adsRenderingSettings = new google.ima.AdsRenderingSettings();
        adsManager = adsManagerLoadedEvent.getAdsManager(
          videoElement,
          adsRenderingSettings,
        );

        adsManager.addEventListener(
          google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,
          function () {
            log("Content pause requested. Starting Ad.");
            videoElement.pause();
            adContainer.style.pointerEvents = "auto";
          },
        );

        adsManager.addEventListener(
          google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,
          function () {
            log("Content resume requested. Ad finished.");
            videoElement.play();
            adContainer.style.pointerEvents = "none";
          },
        );

        [
          google.ima.AdEvent.Type.STARTED,
          google.ima.AdEvent.Type.FIRST_QUARTILE,
          google.ima.AdEvent.Type.MIDPOINT,
          google.ima.AdEvent.Type.THIRD_QUARTILE,
          google.ima.AdEvent.Type.COMPLETE,
        ].forEach(function (event) {
          adsManager.addEventListener(event, function () {
            log("Ad Event: " + event);
          });
        });

        adsManager.addEventListener(
          google.ima.AdErrorEvent.Type.AD_ERROR,
          onAdError,
        );

        try {
          log("Initializing Ad Manager Playback...");
          adsManager.init(640, 480, google.ima.ViewMode.NORMAL);
          adsManager.start();
        } catch (adError) {
          log("Ad Manager Start Error: " + adError.getMessage());
          videoElement.play();
        }
      }

      function onAdError(adErrorEvent) {
        log("AD ERROR: " + adErrorEvent.getError().getMessage());
        if (adsManager) {
          adsManager.destroy();
        }
        videoElement.play();
      }
    </script>
  </body>
</html>
