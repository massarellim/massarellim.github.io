<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prebid Video + Google IMA SDK Integration</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #333; margin-bottom: 20px; }
        
        #playerContainer {
            position: relative;
            width: 640px;
            height: 480px;
            background-color: #000;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        #videoElement { width: 100%; height: 100%; background: black; }
        
        #adContainer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Allow clicks to pass through when no ad is playing */
            z-index: 10;
        }

        .controls { margin-top: 20px; display: flex; gap: 10px; }

        button {
            padding: 10px 20px; font-size: 16px; cursor: pointer;
            background-color: #007bff; color: white; border: none; border-radius: 4px;
            transition: background 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #logArea {
            margin-top: 20px; width: 640px; height: 150px;
            background: #2d2d2d; color: #0f0; padding: 10px;
            overflow-y: auto; font-family: monospace; font-size: 12px;
            border-radius: 4px; border: 1px solid #444;
        }
    </style>

    <script>
        window.__tcfapi = function (command, version, callback, parameter) {
            if (command === "addEventListener" || command === "getTCData") {
                callback({
                    tcString: "CQfDEkAQfDEkAAHABBENCQFsAP_gAEPgABCYJ4EBxC5UQAFCACJyAPoAAAQHQEAIQgAgBAYAASABCJIAAAQEgEAQIAAAICAAAAIAMCQAIAAgAAAAAQAAIIAAIAAAAAAQAAAAIAAAAAAAAQAAAEAAAIAAEAAAgEAEAAAAgAAAAAIACEAAAAAAAAAAAAAAAAAFAAAAAAEAAAAAAAAAACgEAAAAQAAAAAAAABAIBAAAAAAEAAAAAAAAAAAABBPCA-AAsACoAFwAOAAeABAACQAGQANAAmQBcAF0APwAhABOACtAGAAOcAdwBCACLAEcAJMAdsA9oCmwFsALzAZOAywCN4E8AAAA.f_wACHwAAAAA",
                    eventStatus: "tcloaded", cmpStatus: "loaded"
                }, true);
            }
        };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/prebid.js@latest/dist/not-for-prod/prebid.js"></script>
    <script type="text/javascript" src="//imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
</head>
<body>

    <h1>Prebid Video & IMA SDK Demo</h1>

    <div id="playerContainer">
        <video id="videoElement" controls playsinline>
            <source src="https://storage.googleapis.com/gvabox/media/samples/stock.mp4" type="video/mp4" />
        </video>
        <div id="adContainer"></div>
    </div>

    <div class="controls">
        <button id="playButton">Play Video with Ad</button>
    </div>

    <div id="logArea"></div>

    <script>
        // --- Configuration ---
        const PREBID_TIMEOUT = 2000;
        const AD_WIDTH = 640;
        const AD_HEIGHT = 480;
        
        // Globals
        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];
        
        let adsManager;
        let adsLoader;
        let adDisplayContainer;
        let intervalTimer;
        
        const videoElement = document.getElementById('videoElement');
        const adContainer = document.getElementById('adContainer');
        const playButton = document.getElementById('playButton');

        // --- Logger Helper ---
        function log(msg) {
            console.log(msg);
            const logBox = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            logBox.innerHTML += `[${time}] ${msg}<br>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        // --- Prebid Configuration ---
        const videoAdUnit = {
            code: 'video1',
            mediaTypes: {
                video: {
                    playerSize: [AD_WIDTH, AD_HEIGHT],
                    context: 'instream',
                    plcmt: 2,
                    mimes: ['video/mp4'],
                    protocols: [1, 2, 3, 4, 5, 6, 7, 8],
                    playbackmethod: [2]
                }
            },
            bids: [{
                bidder: 'appnexus',
                params: {
                    placementId: 13232361,
                    video: {
                        skippable: true, // Fixed typo
                        playback_method: ['auto_play_sound_off']
                    }
                }
            }]
        };

        pbjs.que.push(() => {
            pbjs.addAdUnits(videoAdUnit);
            pbjs.setConfig({
                debug: true,
                cache: { url: "https://prebid.adnxs.com/pbc/v1/cache" },
                debugging: {
                    enabled: true,
                    intercept: [{
                        when: { adUnitCode: "video1", bidder: "appnexus" },
                        then: {
                            mediaType: "video",
                            cpm: 5.00,
                            vastXml: '<VAST version="2.0"><Ad id="Test"><InLine><AdSystem>Prebid</AdSystem><AdTitle>Test</AdTitle><Creatives><Creative><Linear><Duration>00:00:15</Duration><MediaFiles><MediaFile delivery="progressive" width="640" height="480" type="video/mp4"><![CDATA[https://googleads.github.io/googleads-ima-html5/vsi/videos/android.mp4]]></MediaFile></MediaFiles></Linear></Creative></Creatives></InLine></Ad></VAST>'
                        }
                    }]
                }
            });
        });

        // --- 1. User Interaction ---
        playButton.addEventListener('click', () => {
            playButton.disabled = true;
            log("User clicked Play. Initializing...");

            // IMPORTANT: Initialize IMA Container strictly on user click
            initIMAContainer();

            // Request Bids
            requestBids();
        });

        function initIMAContainer() {
            if (adsManager) { adsManager.destroy(); }
            
            // Create the AdDisplayContainer
            adDisplayContainer = new google.ima.AdDisplayContainer(adContainer, videoElement);
            
            // Must be called as a result of user action
            adDisplayContainer.initialize();
            
            adsLoader = new google.ima.AdsLoader(adDisplayContainer);
            
            // Add Event Listeners
            adsLoader.addEventListener(
                google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
                onAdsManagerLoaded,
                false
            );
            adsLoader.addEventListener(
                google.ima.AdErrorEvent.Type.AD_ERROR,
                onAdError,
                false
            );
        }

        // --- 2. Request Prebid ---
        function requestBids() {
            log("Requesting Prebid Bids...");
            pbjs.que.push(() => {
                pbjs.requestBids({
                    timeout: PREBID_TIMEOUT,
                    adUnitCodes: ['video1'],
                    bidsBackHandler: onBidsBack
                });
            });
        }

        // --- 3. Handle Bids & Build Tag ---
        function onBidsBack(bids) {
            log("Bids received (or timeout).");
            
            const adTagUrl = pbjs.adServers.dfp.buildVideoUrl({
                adUnit: videoAdUnit,
                params: {
                    iu: '/1234/video_demo',
                    cust_params: { section: 'blog' },
                    output: 'vast'
                }
            });

            log("Generated Ad Tag: " + adTagUrl.substring(0, 50) + "...");
            requestAdsFromIMA(adTagUrl);
        }

        // --- 4. Request IMA Ads ---
        function requestAdsFromIMA(adTagUrl) {
            const adsRequest = new google.ima.AdsRequest();
            adsRequest.adTagUrl = adTagUrl;
            
            // Correct dimensions
            adsRequest.linearAdSlotWidth = AD_WIDTH;
            adsRequest.linearAdSlotHeight = AD_HEIGHT;
            adsRequest.nonLinearAdSlotWidth = AD_WIDTH;
            adsRequest.nonLinearAdSlotHeight = AD_HEIGHT / 3;

            log("Requesting ads from IMA SDK...");
            adsLoader.requestAds(adsRequest);
        }

        // --- 5. IMA Events ---
        function onAdsManagerLoaded(adsManagerLoadedEvent) {
            log("Ads Manager Loaded successfully.");
            const adsRenderingSettings = new google.ima.AdsRenderingSettings();
            
            adsManager = adsManagerLoadedEvent.getAdsManager(videoElement, adsRenderingSettings);

            // Ad Event Listeners
            adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, onAdError);
            
            // Handle content pausing/resuming
            adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED, () => {
                log("Ad starting. Pausing content.");
                videoElement.pause();
                adContainer.style.pointerEvents = 'auto'; // Enable clicks on ad
            });
            
            adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED, () => {
                log("Ad finished. Resuming content.");
                videoElement.play();
                adContainer.style.pointerEvents = 'none'; // Disable clicks on ad layer
                playButton.disabled = false;
            });

            try {
                adsManager.init(AD_WIDTH, AD_HEIGHT, google.ima.ViewMode.NORMAL);
                adsManager.start();
            } catch (adError) {
                log("Error starting adsManager: " + adError);
                onAdError(null);
            }
        }

        function onAdError(adErrorEvent) {
            const errorMsg = adErrorEvent ? adErrorEvent.getError().toString() : "Unknown Error";
            log("IMA Error: " + errorMsg);
            if (adsManager) adsManager.destroy();
            
            // Fallback: Just play the content video
            videoElement.play();
            playButton.disabled = false;
        }
        
        // Window Resize Handling
        window.addEventListener('resize', () => {
            if(adsManager) {
                adsManager.resize(videoElement.clientWidth, videoElement.clientHeight, google.ima.ViewMode.NORMAL);
            }
        });

    </script>
</body>
</html>