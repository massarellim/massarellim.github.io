  <html>
    <head>
      <meta charset="utf-8">
      <title>Lazy loading example</title>
      
      <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>
      <script async src="//cdn.jsdelivr.net/npm/prebid.js@latest/dist/not-for-prod/prebid.js"></script>
      
      <script>
        
        window.googletag = window.googletag || {cmd: []};
        var pbjs = pbjs || {};
        pbjs.cmd = pbjs.cmd || [];
        
        googletag.cmd.push(function() {
          
          googletag.defineSlot("/6353/test_1", [300, 250], "div-1")
            .addService(googletag.pubads());
          googletag.defineSlot("/6353/test_2", [300, 250], "div-3")
            .addService(googletag.pubads());
          googletag.defineSlot("/6353/test_3", [300, 250], "div-5")
            .addService(googletag.pubads());
 
          googletag.pubads().disableInitialLoad();
          googletag.enableServices();

          googletag.pubads().addEventListener('slotRequested', function(event) {
            updateSlotStatus(event.slot.getSlotElementId(), 'requested');
          });

          googletag.pubads().addEventListener('slotRenderEnded', function(event) {
            updateSlotStatus(event.slot.getSlotElementId(), 'rendered');
          });

          googletag.pubads().addEventListener('impressionViewable', function(event) {
            updateSlotStatus(event.slot.getSlotElementId(), 'viewed');
          });

          pbjs.cmd.push(function() {

            pbjs.addAdUnits([
              {code:'/6353/test_1', mediaTypes:{banner:{sizes:[300, 250]}}, bids:[{bidder:'appnexus',params:{placementId:1233}},{bidder:'ix',params:{siteId: '9999990'}},{bidder: 'criteo',params: {zoneId: 1455580}}]},
              {code:'/6353/test_2', mediaTypes:{banner:{sizes:[300, 250]}}, bids:[{bidder:'appnexus',params:{placementId:1234}},{bidder:'ix',params:{siteId: '9999990'}},{bidder: 'criteo',params: {zoneId: 1455580}}]},
              {code:'/6353/test_3', mediaTypes:{banner:{sizes:[300, 250]}}, bids:[{bidder:'appnexus',params:{placementId:1234}},{bidder:'ix',params:{siteId: '9999990'}},{bidder: 'criteo',params: {zoneId: 1455580}}]}
            ]);
  
            pbjs.setConfig({
              enableSendAllBids: false,
              debugging: {
                enabled: true, 
                intercept: [{
                  when: {bidder: 'appnexus'}, 
                  then: {cpm: 9.90},
                  options: {delay: 1000},
                },{
                  when: {bidder: 'criteo'}, 
                  then: {cpm: 0.50},
                }]
              }
            });

            auctionOptionsLogging(); // include for logging

            pbjs.bidderSettings = {
              standard: {
                  adserverTargeting: [{
                      key: "hb_bidder",
                      val: function(bidResponse) {
                          return bidResponse.bidderCode;
                      }
                  }, {
                      key: "hb_adid",
                      val: function(bidResponse) {
                          return bidResponse.adId;
                      }
                  }, {
                      key: "hb_pb",
                      val: function(bidResponse) {
                          return bidResponse.pbMg;
                      }
                  }, {
                      key: 'hb_size',
                      val: function (bidResponse) {
                          return bidResponse.size;
                      }
                  }, {
                      key: 'hb_ttr',
                      val: function (bidResponse) {
                          return bidResponse.timeToRespond;
                      }
                  }]
              }
          }
            
            pbjs.requestBids({
              bidsBackHandler: function(){
                pbjs.setTargetingForGPTAsync()
                googletag.pubads().refresh();
              }
            });

// must run before requestBids is invoked
function auctionOptionsLogging() {
    pbjs.onEvent('auctionInit', auction => {
        console.log(`Auction Options: Auction Start at ${auction.timestamp} - ${auction.auctionId}`);
    })

    pbjs.onEvent('bidRequested', bidderRequest => {
        console.log(bidderRequest);
        console.log(`Auction Options: Bid Requested from ${bidderRequest.bidderCode} at ${bidderRequest.start} - ${bidderRequest.auctionId}`);
    })

    pbjs.onEvent('bidResponse', bid => {
        console.log(`Auction Options: Bid Response from ${bid.bidderCode} at ${Date.now()} in ${bid.responseTimestamp - bid.requestTimestamp}ms - ${bid.auctionId}`);
    })

    pbjs.onEvent('noBid', bid => {
        console.log(`Auction Options: No Bid from ${bid.bidder} - ${bid.auctionId}`);
    })

    pbjs.onEvent('bidderDone', bidderRequest => {
        console.log(`Auction Options: Bidder ${bidderRequest.bidderCode} Done in ${Date.now() - bidderRequest.start}ms - ${bidderRequest.auctionId}`);
    })

    pbjs.onEvent('bidTimeout', timedOutBidders => {
        let auctionId = timedOutBidders.length > 0 ? timedOutBidders[0].auctionId : 0
        console.log(`Auction Options: Auction End! Timed Out! Bidders: ${Array.from(new Set(timedOutBidders.map(each => each.bidder))).join(',')} - ${auctionId}`);
    })

    pbjs.onEvent('bidderError', ( error, bidderRequest ) => {
        console.log(`Auction Error: Bidder ${bidderRequest.bidderCode} responded with ${error.status} ${error.statusText} - ${bidderRequest.auctionId}`);
    })

    pbjs.onEvent('auctionEnd', auction => {
        let auctionId = auction.bidderRequests.length > 0 ? auction.bidderRequests[0].auctionId : 0
        let auctionStart = auction.bidderRequests.length > 0 ? auction.bidderRequests[0].auctionStart : 0
        console.log(`Auction Options: Auction End! After ${Date.now() - auctionStart}ms - ${auctionId}`);
        auctionOptionsLog(auctionId)
    })

    pbjs.onEvent('auctionEnd', auction => {
      pbjs.cmd.push(function() {
        let pbjsEvents = pbjs.getEvents();
        console.log(pbjsEvents);
      })
    })

    function auctionOptionsLog(auctionId) {
        let winners = pbjs.getAllWinningBids();
        let output = [];
        let auctionTime = pbjs.getConfig('bidderTimeout');
        const config = pbjs.getConfig('auctionOptions');

        populateData();
        displayData();

        function populateData() {
            function forEach(responses, cb) {
                Object.keys(responses).forEach(function (adUnitCode) {
                    var response = responses[adUnitCode];
                    response.bids.forEach(function (bid) {
                        cb(adUnitCode, bid);
                    });
                });
            }

            forEach(pbjs.getBidResponses(), function (code, bid) {
                output.push({
                    "Auction Options": auctionId,
                    bid: bid,
                    adunit: code,
                    adId: bid.adId,
                    bidder: bid.bidder,
                    secondary: config?.secondaryBidders?.includes(bid.bidder),
                    time: bid.timeToRespond,
                    auctionTimeout: auctionTime,
                    cpm: bid.cpm,
                    msg: bid.statusMessage,
                    rendered: !!winners.find(function (winner) {
                        return winner.adId == bid.adId;
                    })
                });
            });


            forEach(pbjs.getNoBids && pbjs.getNoBids() || {}, function (code, bid) {
                output.push({
                    "Auction Options": auctionId,
                    msg: "no bid",
                    adunit: code,
                    adId: bid.bidId,
                    bidder: bid.bidder,
                    secondary: config?.secondaryBidders?.includes(bid.bidder),
                });
            });
        }

        function displayData() {
            if (output.length) {
                if (console.table) {
                    console.table(output);
                } else {
                    for (var j = 0; j < output.length; j++) {
                        console.log(output[j]);
                    }
                }
            }
        }
    }
}        
          }); 
        });
        
        function updateSlotStatus(slotId, state) {
          var elem = document.getElementById(slotId + '-' + state);
          elem.className = 'activated';
          elem.innerText = 'Yes';
        }
        
      </script>
      <style>
        div.ad-slot {
          border-style: dashed;
          display: block;
          margin: auto;
        }
   
        div.main-content {
          background-color: lightsteelblue;
          margin-top: 230px;
          overflow: hidden;
          width: 100%;
        }
   
        div.status-panel {
          background: white;
          height: 200px;
          position: fixed;
          top: 0;
          width: 100%;
        }
   
        table {
          width: 100%;
        }
   
        table th {
          text-align: center;
        }
   
        table td:not(.slot-name) {
          background-color: lightsalmon;
        }
   
        table td.activated {
          background-color: lightgreen;
        }
      </style>
    </head>
    <body>
   
      <div class="main-content">
        slot1
        <div id="div-1" class="ad-slot" style="width: 300px; height: 250px;">
          <script>
            googletag.cmd.push(function() {
              googletag.display("div-1");
            });
          </script>
        </div>
        <div style="height:200vh"></div>
        slot3
        <div id="div-3" class="ad-slot" style="width: 300px; height: 250px;">
          <script>
            googletag.cmd.push(function() {
              googletag.display("div-3");
            });
          </script>
        </div>
        <div style="height:200vh"></div>
        slot5
        <div id="div-5" class="ad-slot" style="width: 300px; height: 250px;">
          <script>
            googletag.cmd.push(function() {
              googletag.display("div-5");
            });
          </script>
        </div>
      </div>
      <div class="status-panel">
        <table>
          <tr>
            <th>Ad Slot</th>
            <th>Requested?</th>
            <th>Rendered?</th>
            <th>Viewed?</th>
          </tr>
          <tr>
            <td class="slot-name">Ad Slot 1</td>
            <td id="div-1-requested">No</td>
            <td id="div-1-rendered">No</td>
            <td id="div-1-viewed">No</td>
          </tr>
          <tr>
            <td class="slot-name">Ad Slot 2</td>
            <td id="div-3-requested">No</td>
            <td id="div-3-rendered">No</td>
            <td id="div-3-viewed">No</td>
          </tr>
          <tr>
            <td class="slot-name">Ad Slot 3</td>
            <td id="div-5-requested">No</td>
            <td id="div-5-rendered">No</td>
            <td id="div-5-viewed">No</td>
          </tr>
        </table>
        <p>
          Scroll the container below to lazily load the ad slots.
        </p>
      </div>
    </body>
  </html>
