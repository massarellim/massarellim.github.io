<html>
  <head>
    <meta charset="utf-8" />
    <title>Advanced Prebid Example</title>

    <script
      async
      src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"
    ></script>

    <script
      async
      src="//cdn.jsdelivr.net/npm/prebid.js@latest/dist/not-for-prod/prebid.js"
    ></script>

    <script>
      // Constants
      const networkCode = "6353";
      const refreshTimeout = 30 * 1000;
      const globalObjects = ["googletag", "pbjs"];
      const rootMargin = { rootMargin: "300% 0% 300% 0%" };

      const lazyLoadConfig = {
        fetchMarginPercent: 300,
        renderMarginPercent: 25,
        mobileScaling: 1.0,
      };

      const hbConfig = {
        bidder: "appnexus",
        params: { placementId: 123456 },
      };

      const interceptConfig = {
        when: { adUnitCode: /test/ },
        then: { cpm: 9.9, width: 300, height: 250 },
      };

      const slotDefinitions = [
        {
          adUnit: "no_LL_1",
          divId: "div-1",
          sizes: [300, 250],
          isLazyLoad: false,
          hasHb: false,
        },
        {
          adUnit: "no_LL_2",
          divId: "div-2",
          sizes: [320, 50],
          isLazyLoad: false,
          hasHb: false,
        },
        {
          adUnit: "test_1",
          divId: "div-3",
          sizes: [300, 250],
          isLazyLoad: true,
          hasHb: true,
        },
        {
          adUnit: "no_HB_1",
          divId: "div-4",
          sizes: [320, 50],
          isLazyLoad: true,
          hasHb: false,
        },
        {
          adUnit: "test_2",
          divId: "div-5",
          sizes: [300, 250],
          isLazyLoad: true,
          hasHb: true,
        },
        {
          adUnit: "no_HB_2",
          divId: "div-6",
          sizes: [320, 50],
          isLazyLoad: true,
          hasHb: false,
        },
        {
          adUnit: "test_3",
          divId: "div-7",
          sizes: [300, 250],
          isLazyLoad: true,
          hasHb: true,
        },
        {
          adUnit: "no_HB_3",
          divId: "div-8",
          sizes: [320, 50],
          isLazyLoad: true,
          hasHb: false,
        },
      ];

      // Utility function to define slots
      function defineAdSlot(adUnit, sizes, divId) {
        return googletag
          .defineSlot(`/${networkCode}/${adUnit}`, sizes, divId)
          .addService(googletag.pubads());
      }

      // Utility function to init slots based on lazyload
      function filterSlots(slots, shouldBeLazy) {
        const slotsMap = slots
          .filter((slot) => slot.isLazyLoad === shouldBeLazy)
          .reduce((acc, slot) => {
            acc[slot.divId] = defineAdSlot(slot.adUnit, slot.sizes, slot.divId);
            return acc;
          }, {});
        return slotsMap;
      }

      // Utility function to convert slotsMap objects to arrays
      function objectToArray(obj) {
        if (typeof Object.values(obj)[0] === "object") {
          return Object.values(obj);
        } else {
          return [obj];
        }
      }

      // Utility function to get ad unit paths from slots
      function getSlotPath(slots) {
        return slots.map((slot) => slot.getAdUnitPath());
      }

      // Utility function to request bids from prebid and update GAM targeting
      function sendAdRequest(slotsMap) {
        const slotsArray = objectToArray(slotsMap);
        const slotsPaths = getSlotPath(slotsArray);
        googletag.cmd.push(function () {
          pbjs.cmd.push(function () {
            pbjs.requestBids({
              bidsBackHandler: function () {
                pbjs.setTargetingForGPTAsync(slotsPaths);
                googletag.pubads().refresh(slotsArray);
              },
              adUnitCodes: slotsPaths,
            });
          });
        });
      }

      // Utility function to update the status of a slot in the UI
      function updateSlotStatus(slotId, state) {
        const elem = document.getElementById(`${slotId}-${state}`);
        if (state == "requested" && elem.className == "activated") {
          const refresh = document.getElementById(`${slotId}-refreshed`);
          refresh.className = "activated";
          refresh.innerText = +refresh.innerText + 1;
        } else if (elem) {
          elem.className = "activated";
          elem.innerText = "Yes";
        }
      }

      // Initialize global objects if they don't exist
      globalObjects.forEach((obj) => {
        window[obj] = window[obj] || { cmd: [] };
      });

      googletag.cmd.push(function () {
        // Register event listeners for GAM
        googletag.pubads().addEventListener("slotRequested", (event) => {
          updateSlotStatus(event.slot.getSlotElementId(), "requested");
        });

        googletag.pubads().addEventListener("slotRenderEnded", (event) => {
          updateSlotStatus(event.slot.getSlotElementId(), "rendered");
        });

        googletag.pubads().addEventListener("impressionViewable", (event) => {
          updateSlotStatus(event.slot.getSlotElementId(), "viewed");
          setTimeout(() => {
            sendAdRequest(event.slot);
          }, refreshTimeout);
        });

        // Enable SRA and disable load for Prebid
        googletag.pubads().enableSingleRequest();
        googletag.pubads().disableInitialLoad();

        // Define ATF slots and call GAM
        const atfSlotsMap = filterSlots(slotDefinitions, false);
        googletag.enableServices();
        googletag.pubads().refresh(objectToArray(atfSlotsMap));

        // Enable Lazy Load for BTF slots
        googletag.pubads().enableLazyLoad(lazyLoadConfig);

        // Define BTF slots and map them to Prebid slots
        const btfSlotsMap = filterSlots(slotDefinitions, true);
        const prebidAdUnits = slotDefinitions
          .filter((slot) => slot.isLazyLoad && slot.hasHb)
          .map((slot) => ({
            code: `/${networkCode}/${slot.adUnit}`,
            mediaTypes: { banner: { sizes: [slot.sizes] } },
            bids: [hbConfig],
          }));

        // Define Prebid slots
        pbjs.cmd.push(function () {
          pbjs.addAdUnits(prebidAdUnits);

          // Setup debug intercepts to always force Prebid to respond
          pbjs.setConfig({
            debugging: {
              enabled: true,
              intercept: [interceptConfig],
            },
          });

          // Define intersection observers to lazily trigger ad requests
          const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const ad = entry.target;
                sendAdRequest(btfSlotsMap[ad.id]);
                observer.unobserve(ad);
                ad.classList.remove("lazy");
              }
            });
          }, rootMargin);

          // Initialize intersection observers for lazy slots
          const lazyAds = document.querySelectorAll(".lazy");
          lazyAds.forEach((ad) => {
            observer.observe(ad);
          });
        });
      });
    </script>

    <style>
      div.ad-slot {
        border-style: dashed;
        display: block;
        margin: auto;
      }

      div.main-content {
        background-color: lightsteelblue;
        margin-top: 250px;
        overflow: hidden;
        width: 100%;
      }

      div.status-panel {
        background: white;
        height: 250px;
        position: fixed;
        top: 0;
        width: 100%;
      }

      table {
        width: 90%;
        margin: auto;
      }

      table th {
        text-align: left;
      }

      table td:not(.slot-name) {
        background-color: lightsalmon;
      }

      table td.activated {
        background-color: lightgreen;
      }
    </style>
  </head>

  <body>
    <div class="main-content">
      slot1
      <div id="div-1" class="ad-slot" style="width: 300px; height: 250px">
        <script>
          googletag.cmd.push(function () {
            googletag.display("div-1");
          });
        </script>
      </div>

      <div style="height: 200vh"></div>
      slot2
      <div id="div-2" class="ad-slot" style="width: 320px; height: 50px">
        <script>
          googletag.cmd.push(function () {
            googletag.display("div-2");
          });
        </script>
      </div>

      <div style="height: 200vh"></div>
      slot3
      <div id="div-3" class="lazy ad-slot" style="width: 300px; height: 250px">
        <script>
          googletag.cmd.push(function () {
            googletag.display("div-3");
          });
        </script>
      </div>

      <div style="height: 200vh"></div>
      slot4
      <div id="div-4" class="lazy ad-slot" style="width: 320px; height: 50px">
        <script>
          googletag.cmd.push(function () {
            googletag.display("div-4");
          });
        </script>
      </div>

      <div style="height: 200vh"></div>
      slot5
      <div id="div-5" class="lazy ad-slot" style="width: 300px; height: 250px">
        <script>
          googletag.cmd.push(function () {
            googletag.display("div-5");
          });
        </script>
      </div>

      <div style="height: 200vh"></div>
      slot6
      <div id="div-6" class="lazy ad-slot" style="width: 320px; height: 50px">
        <script>
          googletag.cmd.push(function () {
            googletag.display("div-6");
          });
        </script>
      </div>

      <div style="height: 200vh"></div>
      slot7
      <div id="div-7" class="lazy ad-slot" style="width: 300px; height: 250px">
        <script>
          googletag.cmd.push(function () {
            googletag.display("div-7");
          });
        </script>
      </div>

      <div style="height: 200vh"></div>
      slot8
      <div id="div-8" class="lazy ad-slot" style="width: 320px; height: 50px">
        <script>
          googletag.cmd.push(function () {
            googletag.display("div-8");
          });
        </script>
      </div>

      <div style="height: 10vh"></div>
    </div>

    <div class="status-panel">
      <table>
        <tr>
          <th>Ad Slot</th>
          <th>Requested?</th>
          <th>Rendered?</th>
          <th>Viewed?</th>
          <th>Refreshed?</th>
        </tr>
        <tr>
          <td class="slot-name">Ad Slot 1</td>
          <td id="div-1-requested">No</td>
          <td id="div-1-rendered">No</td>
          <td id="div-1-viewed">No</td>
          <td id="div-1-refreshed">0</td>
        </tr>
        <tr>
          <td class="slot-name">Ad Slot 2</td>
          <td id="div-2-requested">No</td>
          <td id="div-2-rendered">No</td>
          <td id="div-2-viewed">No</td>
          <td id="div-2-refreshed">0</td>
        </tr>
        <tr>
          <td class="slot-name">Ad Slot 3</td>
          <td id="div-3-requested">No</td>
          <td id="div-3-rendered">No</td>
          <td id="div-3-viewed">No</td>
          <td id="div-3-refreshed">0</td>
        </tr>
        <tr>
          <td class="slot-name">Ad Slot 4</td>
          <td id="div-4-requested">No</td>
          <td id="div-4-rendered">No</td>
          <td id="div-4-viewed">No</td>
          <td id="div-4-refreshed">0</td>
        </tr>
        <tr>
          <td class="slot-name">Ad Slot 5</td>
          <td id="div-5-requested">No</td>
          <td id="div-5-rendered">No</td>
          <td id="div-5-viewed">No</td>
          <td id="div-5-refreshed">0</td>
        </tr>
        <tr>
          <td class="slot-name">Ad Slot 6</td>
          <td id="div-6-requested">No</td>
          <td id="div-6-rendered">No</td>
          <td id="div-6-viewed">No</td>
          <td id="div-6-refreshed">0</td>
        </tr>
        <tr>
          <td class="slot-name">Ad Slot 7</td>
          <td id="div-7-requested">No</td>
          <td id="div-7-rendered">No</td>
          <td id="div-7-viewed">No</td>
          <td id="div-7-refreshed">0</td>
        </tr>
        <tr>
          <td class="slot-name">Ad Slot 8</td>
          <td id="div-8-requested">No</td>
          <td id="div-8-rendered">No</td>
          <td id="div-8-viewed">No</td>
          <td id="div-8-refreshed">0</td>
        </tr>
      </table>
      <p>Scroll the container below to lazily load the ad slots.</p>
    </div>
  </body>
</html>
