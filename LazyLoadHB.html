  <html>
    <head>
      <meta charset="utf-8">
      <title>Lazy loading example</title>
      <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>
      <script async src="//cdn.jsdelivr.net/npm/prebid.js@latest/dist/not-for-prod/prebid.js"></script>
      <script>
          // Lazy load slots setup
          const items = [
              {
                  id: 'div-4',
                  lfetch: 500, 
                  lrender: 300,
                  lname: '/6353/test',
                  lsizes: [300, 250]
              },
              {
                  id: 'div-5',
                  lfetch: 200, 
                  lrender: 50,             
                  lname: '/6353/test',
                  lsizes: [300, 250]
              },
              {
                  id: 'div-6',
                  lfetch: 200, 
                  lrender: 50,
                  lname: '/6353/test',
                  lsizes: [300, 250]
              }
   
          ];
   
     
          window.googletag = window.googletag || {cmd: []};
          var pbjs = pbjs || {};
          pbjs.cmd = pbjs.cmd || [];
          
          googletag.cmd.push(function() {
          // SRA Slots (**WONT BE AFFECTED BY LAZY LOAD**)
          var slots = [
          googletag.defineSlot("/6353/test", [300, 250], "div-1")
            .addService(googletag.pubads());
          googletag.defineSlot("/6353/test", [300, 250], "div-2")
            .addService(googletag.pubads());
          googletag.defineSlot("/6353/test", [300, 250], "div-3")
            .addService(googletag.pubads());
          ];
   
          // Enable SRA and services.
          googletag.pubads().enableSingleRequest();
          googletag.enableServices(); 
   
           // Issue first SRA request (slots 1, 2 and 3) immediately.
          googletag.pubads().refresh();     
   
          // Register event handlers to observe lazy loading behavior on status
          // table on top of page (not required for actual implementation).
          googletag.pubads().addEventListener('slotRequested', function(event) {
            updateSlotStatus(event.slot.getSlotElementId(), 'fetched');
          });
   
          googletag.pubads().addEventListener('slotOnload', function(event) {
            updateSlotStatus(event.slot.getSlotElementId(), 'rendered');
          });
   
        });
  
   
        //Function to be used to enable custom lazy loading, accepts div as
        //parameter which contain specific fetch/render configurations as defined
        //on custom fetch/render map
        newLazyLoad = (newdiv) => {
          googletag.cmd.push(function() {
          // Search data of the desired adunit
          let ad_unit = items.find(item => item.id == newdiv)
          // Page Level Target Update
          let slo ={};
          slo[newdiv] = googletag.defineSlot(ad_unit.lname,ad_unit.lsizes, newdiv)
            .addService(googletag.pubads()),
          // Enable Lazy Loading
            googletag.pubads().enableLazyLoad({
             fetchMarginPercent: ad_unit.lfetch,  
             // Fetch slots within customfetchrendermap object definitions of viewports.
             renderMarginPercent: ad_unit.lrender,  
             // Render slots within customfetchrendermap object definitions of viewports.
              mobileScaling: 1.0 
            });
          console.log(slo)
            // checking in console if it's defining lazyloading according to customfetchrendermap definition
            googletag.display(newdiv);
            googletag.pubads().refresh([slo[newdiv]]);
          });
          }
   
        //function only to paint status table on top of page according to fetch/render (not needed on actual implementation)
        function updateSlotStatus(slotId, state) {
          var elem = document.getElementById(slotId + '-' + state);
          elem.className = 'activated';
          elem.innerText = 'Yes';
        }
      </script>
      <style>
        div.ad-slot {
          border-style: dashed;
          display: block;
          margin: auto;
        }
   
        div.main-content {
          background-color: lightsteelblue;
          margin-top: 230px;
          overflow: hidden;
          width: 100%;
        }
   
        div.status-panel {
          background: white;
          height: 200px;
          position: fixed;
          top: 0;
          width: 100%;
        }
   
        table {
          width: 100%;
        }
   
        table th {
          text-align: center;
        }
   
        table td:not(.slot-name) {
          background-color: lightsalmon;
        }
   
        table td.activated {
          background-color: lightgreen;
        }
      </style>
    </head>
    <body>
   
      <div class="main-content">
        slot1
        <div id="div-1" class="ad-slot" style="height: 300px; width: 250px;">
        </div>
   
        <div style="height:300vh"></div>
        slot2
        <div id="div-2" class="ad-slot" style="height: 300px; width: 250px;">
        </div>
   
        <div style="height:20vh"></div>
        slot3
        <div id="div-3" class="ad-slot" style="height: 300px; width: 250px;">
        </div>
   
   
        <div style="height:900vh;background:#ccc"></div>
        slot4
        <div id="div-4" class="ad-slot" style="height: 300px; width: 250px;">
          <script>
            newLazyLoad('div-4');
          </script>
        </div>
        <div style="height:900vh;background:#ccc"></div>
        slot5
        <div id="div-5" class="ad-slot" style="height: 300px; width: 250px;">
          <script>
           newLazyLoad('div-5');
          </script>
        </div>
        <div style="height:900vh;background:#ccc"></div>
        slot6
        <div id="div-6" class="ad-slot" style="height: 300px; width: 250px;">
          <script>
            newLazyLoad('div-6');       
          </script>
        </div>
      </div>
   
      <div class="status-panel">
        <table>
          <tr>
            <th>Ad Slot</th>
            <th>Fetched?</th>
            <th>Rendered?</th>
          </tr>
          <tr>
            <td class="slot-name">Ad Slot 1</td>
            <td id="div-1-fetched">No</td>
            <td id="div-1-rendered">No</td>
          </tr>
          <tr>
            <td class="slot-name">Ad Slot 2</td>
            <td id="div-2-fetched">No</td>
            <td id="div-2-rendered">No</td>
          </tr>
          <tr>
            <td class="slot-name">Ad Slot 3</td>
            <td id="div-3-fetched">No</td>
            <td id="div-3-rendered">No</td>
          </tr>
          <tr>
            <td class="slot-name">Ad Slot 4</td>
            <td id="div-4-fetched">No</td>
            <td id="div-4-rendered">No</td>
          </tr>
          <tr>
            <td class="slot-name">Ad Slot 5</td>
            <td id="div-5-fetched">No</td>
            <td id="div-5-rendered">No</td>
          </tr>
          <tr>
            <td class="slot-name">Ad Slot 6</td>
            <td id="div-6-fetched">No</td>
            <td id="div-6-rendered">No</td>
          </tr> 
          <tr>
            <td class="slot-name">Ad Slot 7</td>
            <td id="div-7-fetched">No</td>
            <td id="div-7-rendered">No</td>
          </tr> 
        </table>
        <p>
          Scroll the container below to lazily load the ad slots.
        </p>
      </div>
    </body>
  </html>

