<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Universal Ad Tag Parser v8 (Complete)</title>
    <style>
      :root {
        --primary: #1967d2;
        --bg: #f8f9fa;
        --border: #dadce0;
        --text: #202124;
        --desc-text: #5f6368;
        --code-text: #d93025;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      h1 {
        margin-bottom: 5px;
        font-size: 24px;
      }
      .subtitle {
        color: var(--desc-text);
        margin-bottom: 20px;
        font-size: 14px;
      }

      .input-group {
        background: white;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid var(--border);
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
      }

      textarea {
        flex-grow: 1;
        height: 100px;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-family: "Roboto Mono", monospace;
        font-size: 12px;
        resize: vertical;
      }

      button {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 0 25px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #1765cc;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid var(--border);
        table-layout: fixed;
        font-size: 13px;
      }

      th,
      td {
        text-align: left;
        padding: 6px 10px;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
        word-wrap: break-word;
      }

      th {
        background-color: #f1f3f4;
        color: var(--desc-text);
        text-transform: uppercase;
        font-size: 11px;
        font-weight: 700;
      }

      tr:hover {
        background-color: #f8faff;
      }

      .col-param {
        width: 160px;
        font-family: "Roboto Mono", monospace;
        color: var(--code-text);
        font-weight: 700;
      }
      .col-val {
        width: 35%;
        font-family: "Roboto Mono", monospace;
        color: #3c4043;
        font-size: 12px;
      }
      .col-desc {
        width: auto;
        line-height: 1.4;
      }

      /* Badge System */
      .desc-row {
        display: flex;
        align-items: baseline;
        gap: 8px;
        flex-wrap: wrap;
      }
      .desc-title {
        font-weight: 700;
        color: #202124;
      }
      .desc-text {
        color: var(--desc-text);
      }

      .badge {
        display: inline-block;
        font-size: 10px;
        padding: 1px 5px;
        border-radius: 3px;
        font-weight: 700;
        text-transform: uppercase;
        white-space: nowrap;
      }
      /* Categories */
      .b-core {
        background: #e6f4ea;
        color: #137333;
        border: 1px solid #ceead6;
      }
      .b-pod {
        background: #fce8e6;
        color: #c5221f;
        border: 1px solid #fad2cf;
      }
      .b-dai {
        background: #e8f0fe;
        color: #1967d2;
        border: 1px solid #d2e3fc;
      }
      .b-dev {
        background: #fff8e1;
        color: #f29900;
        border: 1px solid #fce8b2;
      } /* Device/Signals */
      .b-priv {
        background: #f1f3f4;
        color: #5f6368;
        border: 1px solid #ddadad;
      } /* Privacy */
      .b-int {
        background: #f3e5f5;
        color: #7b1fa2;
        border: 1px solid #e1bee7;
      } /* Internal/Debug */
      .b-omid {
        background: #e0f2f1;
        color: #00695c;
        border: 1px solid #b2dfdb;
      } /* Open Measurement */

      .sub-table {
        width: 100%;
        border: 1px solid #eee;
        margin-top: 4px;
        background: #fff;
        border-radius: 4px;
      }
      .sub-table td {
        padding: 3px 5px;
        border-bottom: 1px solid #eee;
        font-size: 11px;
        font-family: "Roboto Mono";
      }
      .sub-table .key {
        width: 80px;
        color: #444;
        font-weight: 600;
      }

      .empty-state {
        text-align: center;
        padding: 30px;
        color: var(--desc-text);
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h1>
      Universal Ad Tag Parser
      <span style="font-weight: normal; font-size: 16px; color: #5f6368"
        >v8 (Complete)</span
      >
    </h1>

    <div class="input-group">
      <textarea id="urlInput" placeholder="Paste Ad Tag URL here..."></textarea>
      <button onclick="parseUrl()">Decode</button>
    </div>

    <div id="resultsArea">
      <div class="empty-state">Results will appear here...</div>
    </div>

    <script>
      // --- DICTIONARY ---
      const paramDict = {
        // --- CORE / STANDARD ---
        iu: { t: "Ad Unit", cat: "core", d: "Inventory path (Ad Unit)." },
        sz: { t: "Size", cat: "core", d: "Slot size (e.g. 640x480)." },
        gdfp_req: { t: "Google Schema", cat: "core", d: "Must be '1'." },
        env: {
          t: "Environment",
          cat: "core",
          d: "'vp' (player) or 'instream'.",
        },
        output: { t: "Output", cat: "core", d: "vast, vmap, ldjh, xml_vast4." },
        unviewed_position_start: {
          t: "Delayed Imp",
          cat: "core",
          d: "1=Count on view (Standard).",
        },
        description_url: {
          t: "Desc URL",
          cat: "core",
          d: "Content Context URL.",
        },
        url: { t: "Page URL", cat: "core", d: "Full page URL." },
        correlator: {
          t: "Correlator",
          cat: "core",
          d: "Cache buster timestamp.",
        },
        adk: {
          t: "Ad Key",
          cat: "core",
          d: "Unique slot identifier (SRA safe).",
        },
        sid: { t: "Session ID", cat: "core", d: "Session identifier." },
        ciu_szs: { t: "Companions", cat: "core", d: "Companion banner sizes." },

        // --- LATENCY / DEBUG (Internal) ---
        dt: {
          t: "Display Time",
          cat: "int",
          d: "Timestamp (ms) request started.",
        },
        dlt: { t: "Down Latency", cat: "int", d: "Download time (ms)." },
        idt: { t: "Impression Delay", cat: "int", d: "Time to impression." },
        ged: {
          t: "Google Event Data",
          cat: "int",
          d: "Detailed latency timings.",
        },
        gedve: { t: "Event Data", cat: "int", d: "Legacy event data." },
        eid: { t: "Experiment IDs", cat: "int", d: "Active A/B test IDs." },
        htps: { t: "HTTPS", cat: "int", d: "Secure signal." },
        nel: { t: "Network Log", cat: "int", d: "Network Error Logging." },
        eoid: { t: "Exchange Order", cat: "int", d: "Internal Order ID." },
        eoidce: {
          t: "Order Signal",
          cat: "int",
          d: "Internal Order/Exchange flag.",
        },
        pvsid: { t: "Page View ID", cat: "int", d: "Unique Page View ID." },
        ptpl: { t: "Template ID", cat: "int", d: "Publisher Template ID." },
        ptt: {
          t: "Page Tag Type",
          cat: "int",
          d: "Tag type (20=HTML5 VSI/IMA).",
        },
        sdr: {
          t: "Render Signal",
          cat: "int",
          d: "Server Dedupe/Render signal.",
        },

        // --- SDK / OPEN MEASUREMENT (OMID) / PLAYER ---
        sdki: {
          t: "SDK Internal",
          cat: "dev",
          d: "SDK Implementation Version.",
        },
        sdkv: { t: "SDK Version", cat: "dev", d: "Public SDK Version." },
        sdk_apis: {
          t: "Supported APIs",
          cat: "omid",
          d: "2=MRAID, 7=OMID 1.0, 8=OMID 1.2.",
        },
        omid_p: {
          t: "OMID Partner",
          cat: "omid",
          d: "Open Measurement Partner (Google).",
        },
        vo: { t: "Verif Opt", cat: "omid", d: "Verification enabled." },
        vpa: { t: "Auto-Play", cat: "dev", d: "auto or click." },
        vpmute: { t: "Muted", cat: "dev", d: "1=Started muted." },
        osd: { t: "On Screen", cat: "dev", d: "On screen duration." },
        frm: { t: "Frame Rate", cat: "dev", d: "Friendly Iframe signal." },
        vis: {
          t: "Visibility",
          cat: "dev",
          d: "Visibility state (1=Visible).",
        },
        mpt: {
          t: "Player Type",
          cat: "dev",
          d: "Media Player Title (e.g. h5_vsi).",
        },
        u_so: { t: "Orientation", cat: "dev", d: "l=Landscape, p=Portrait." },
        ctv: { t: "Connected TV", cat: "dev", d: "1=Is CTV device." },
        is_amp: { t: "Is AMP", cat: "dev", d: "1=Accelerated Mobile Page." },

        // --- DEVICE / DISPLAY SPECIFIC ---
        uach: {
          t: "UA Hints",
          cat: "dev",
          d: "User Agent Client Hints (Base64).",
        },
        cookie_enabled: {
          t: "Cookies On",
          cat: "dev",
          d: "1=Browser cookies enabled.",
        },
        hl: { t: "Language", cat: "dev", d: "Browser language." },

        // --- TARGETING / DAI ---
        cust_params: { t: "Custom Params", cat: "core", d: "Key-values." },
        scp: { t: "Slot Params", cat: "core", d: "Slot key-values." },
        ppid: { t: "PPID", cat: "dai", d: "Publisher Provided ID." },
        scor: { t: "Scoring", cat: "dai", d: "Competitive exclusion score." },
        cookie: { t: "Cookie Hash", cat: "dai", d: "User ID hash." },
        media_url: { t: "Media URL", cat: "core", d: "Creative/Asset URL." },

        // --- PRIVACY ---
        tfcd: { t: "Child Directed", cat: "priv", d: "1=COPPA." },
        npa: { t: "Non-Personal", cat: "priv", d: "1=GDPR/CCPA." },
        gdpr: { t: "GDPR", cat: "priv", d: "1=Applies." },
        gdpr_consent: { t: "GDPR String", cat: "priv", d: "Consent string." },
        addtl_consent: {
          t: "Addtl Consent",
          cat: "priv",
          d: "Google Ad Tech Providers (ATP).",
        },
      };

      function parseUrl() {
        const input = document.getElementById("urlInput").value.trim();
        const resultsArea = document.getElementById("resultsArea");

        if (!input) {
          return;
        }

        try {
          // Regex to find URL (even in text)
          let urlToParse = input.match(/https?:\/\/[^\s"']+/)
            ? input.match(/https?:\/\/[^\s"']+/)[0]
            : input;
          urlToParse = urlToParse.replace(/&amp;/g, "&");

          let queryString = urlToParse.includes("?")
            ? urlToParse.split("?")[1]
            : urlToParse;
          const params = new URLSearchParams(queryString);
          const entries = [];

          for (const [key, value] of params.entries()) {
            entries.push({ key, value });
          }

          if (entries.length === 0) {
            resultsArea.innerHTML =
              '<div class="empty-state">No parameters found.</div>';
            return;
          }

          let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="col-param">Parameter</th>
                            <th class="col-val">Value</th>
                            <th class="col-desc">Description</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

          entries.forEach((item) => {
            let key = item.key;
            let def = paramDict[key];

            // Fallback
            if (!def) def = { t: "Unknown", cat: "misc", d: "" };

            // Value Processing
            let valDisplay = escapeHtml(item.value);

            // 1. Cust Params & Slot Params
            if (key === "cust_params" || key === "scp") {
              valDisplay = formatCustParams(item.value);
            }
            // 2. UA Client Hints (Base64)
            else if (key === "uach") {
              valDisplay = formatBase64Json(item.value);
            }
            // 3. GED / GEDVE (Performance Timings)
            else if (key === "ged" || key === "gedve") {
              valDisplay = formatGed(item.value);
            }
            // 4. Comma Separated Lists (eid, sdk_apis)
            else if (key === "eid" || key === "sdk_apis") {
              valDisplay = item.value.split(",").join(", ");
            }
            // 5. Standard Decode
            else {
              try {
                valDisplay = decodeURIComponent(valDisplay);
              } catch (e) {}
            }

            // Badges
            let bClass = "b-priv";
            if (def.cat === "core") bClass = "b-core";
            if (def.cat === "pod") bClass = "b-pod";
            if (def.cat === "dai") bClass = "b-dai";
            if (def.cat === "dev") bClass = "b-dev";
            if (def.cat === "int") bClass = "b-int"; // Internal
            if (def.cat === "omid") bClass = "b-omid"; // Omid

            html += `
                    <tr>
                        <td class="col-param">${key}</td>
                        <td class="col-val">${valDisplay}</td>
                        <td class="col-desc">
                            <div class="desc-row">
                                <span class="badge ${bClass}">${def.cat === "misc" ? "?" : def.cat}</span>
                                <span class="desc-title">${def.t}:</span>
                                <span class="desc-text">${def.d}</span>
                            </div>
                        </td>
                    </tr>
                `;
          });

          html += `</tbody></table>`;
          resultsArea.innerHTML = html;
        } catch (e) {
          resultsArea.innerHTML = `<div class="empty-state">Error: ${e.message}</div>`;
        }
      }

      // Helper: Cust Params
      function formatCustParams(str) {
        try {
          const dec = decodeURIComponent(str);
          const pairs = dec.split("&");
          if (pairs.length === 0) return dec;
          let sub = `<table class="sub-table">`;
          pairs.forEach((p) => {
            const parts = p.split("=");
            sub += `<tr><td class="key">${escapeHtml(parts[0])}</td><td>${escapeHtml(parts.slice(1).join("="))}</td></tr>`;
          });
          return sub + `</table>`;
        } catch (e) {
          return escapeHtml(str);
        }
      }

      // Helper: Base64 JSON
      function formatBase64Json(str) {
        try {
          const jsonStr = atob(str);
          const jsonObj = JSON.parse(jsonStr);
          let sub = `<table class="sub-table">`;
          for (const [k, v] of Object.entries(jsonObj)) {
            let displayVal = typeof v === "object" ? JSON.stringify(v) : v;
            sub += `<tr><td class="key">${escapeHtml(k)}</td><td>${escapeHtml(displayVal)}</td></tr>`;
          }
          return sub + `</table>`;
        } catch (e) {
          return escapeHtml(str);
        }
      }

      // Helper: GED/GEDVE (Google Event Data)
      // Format: ve4_td411_tt410...
      function formatGed(str) {
        try {
          const parts = str.split("_");
          if (parts.length < 2) return str;
          let sub = `<table class="sub-table">`;
          parts.forEach((p) => {
            // Split key from value (e.g., "td411" -> "td": "411")
            // Heuristic: alphabetic prefix is key
            const match = p.match(/^([a-z]+)(.*)$/);
            if (match) {
              sub += `<tr><td class="key">${match[1]}</td><td>${match[2]}</td></tr>`;
            } else {
              sub += `<tr><td class="key">-</td><td>${p}</td></tr>`;
            }
          });
          return sub + `</table>`;
        } catch (e) {
          return str;
        }
      }

      function escapeHtml(t) {
        if (!t) return t;
        return String(t)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }
    </script>
  </body>
</html>
