<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Universal Ad Tag Parser (Video + GPT Display)</title>
    <style>
      :root {
        --primary: #1967d2;
        --bg: #f8f9fa;
        --border: #dadce0;
        --text: #202124;
        --desc-text: #5f6368;
        --code-text: #d93025;
        --alias-text: #e37400;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      h1 {
        margin-bottom: 5px;
        font-size: 24px;
      }
      .subtitle {
        color: var(--desc-text);
        margin-bottom: 20px;
        font-size: 14px;
      }

      .input-group {
        background: white;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid var(--border);
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: flex-start;
      }

      textarea {
        flex-grow: 1;
        height: 60px;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-family: "Roboto Mono", monospace;
        font-size: 12px;
        resize: vertical;
      }

      button {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 0 20px;
        height: 60px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 4px;
        cursor: pointer;
        white-space: nowrap;
      }
      button:hover {
        background-color: #1765cc;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid var(--border);
        table-layout: fixed;
        font-size: 13px;
      }

      th,
      td {
        text-align: left;
        padding: 6px 10px;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
        word-wrap: break-word;
      }

      th {
        background-color: #f1f3f4;
        color: var(--desc-text);
        text-transform: uppercase;
        font-size: 11px;
        font-weight: 700;
      }

      tr:hover {
        background-color: #f8faff;
      }

      .col-param {
        width: 150px;
        font-family: "Roboto Mono", monospace;
        color: var(--code-text);
        font-weight: 700;
      }
      .col-val {
        width: 35%;
        font-family: "Roboto Mono", monospace;
        color: #3c4043;
        font-size: 12px;
      }
      .col-desc {
        width: auto;
        line-height: 1.4;
      }

      .desc-row {
        display: flex;
        align-items: baseline;
        gap: 8px;
        flex-wrap: wrap;
      }
      .desc-title {
        font-weight: 700;
        color: #202124;
      }
      .desc-text {
        color: var(--desc-text);
      }

      /* Badges */
      .badge {
        display: inline-block;
        font-size: 10px;
        padding: 1px 5px;
        border-radius: 3px;
        font-weight: 700;
        text-transform: uppercase;
        white-space: nowrap;
        line-height: 1.2;
      }
      .b-core {
        background: #e6f4ea;
        color: #137333;
        border: 1px solid #ceead6;
      } /* Video Core */
      .b-pod {
        background: #fce8e6;
        color: #c5221f;
        border: 1px solid #fad2cf;
      } /* Pods */
      .b-dai {
        background: #e8f0fe;
        color: #1967d2;
        border: 1px solid #d2e3fc;
      } /* Targeting */
      .b-disp {
        background: #e9f2ff;
        color: #0b57d0;
        border: 1px solid #c3d9fc;
      } /* Display/GPT */
      .b-dev {
        background: #fff8e1;
        color: #f29900;
        border: 1px solid #fce8b2;
      } /* Device/Signals */
      .b-priv {
        background: #f1f3f4;
        color: #5f6368;
        border: 1px solid #ddadad;
      } /* Privacy */

      /* Sub-tables */
      .sub-table {
        width: 100%;
        border: 1px solid #eee;
        margin-top: 4px;
        background: #fff;
        border-radius: 4px;
      }
      .sub-table td {
        padding: 4px 6px;
        border-bottom: 1px solid #eee;
        font-size: 11px;
        font-family: "Roboto Mono";
      }
      .sub-table .key {
        width: 100px;
        color: #444;
        font-weight: 600;
      }

      .empty-state {
        text-align: center;
        padding: 30px;
        color: var(--desc-text);
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h1>
      Universal Ad Tag Parser
      <span style="font-weight: normal; font-size: 16px; color: #5f6368"
        >(Video + Display)</span
      >
    </h1>

    <div class="input-group">
      <textarea id="urlInput" placeholder="Paste Ad Tag URL here..."></textarea>
      <button onclick="parseUrl()">Decode</button>
    </div>

    <div id="resultsArea">
      <div class="empty-state">Results will appear here...</div>
    </div>

    <script>
      // --- DICTIONARY ---
      // Combined VAST (Video) and GPT (Display) parameters
      const paramDict = {
        // --- CORE VIDEO & COMMON ---
        iu: { t: "Ad Unit", cat: "core", d: "The ad unit path (inventory)." },
        sz: { t: "Size", cat: "core", d: "Master slot size." },
        gdfp_req: { t: "Google Schema", cat: "core", d: "Must be '1'." },
        env: {
          t: "Environment",
          cat: "core",
          d: "'vp' (player) or 'instream'.",
        },
        output: {
          t: "Output",
          cat: "core",
          d: "vast, vmap, ldjh (List Display).",
        },
        unviewed_position_start: {
          t: "Delayed Imp",
          cat: "core",
          d: "1=Count on view (Standard).",
        },
        description_url: {
          t: "Desc URL",
          cat: "core",
          d: "Page content URL (Context).",
        },
        url: { t: "Page URL", cat: "core", d: "Full page URL." },
        correlator: {
          t: "Correlator",
          cat: "core",
          d: "Timestamp for exclusions.",
        },
        dt: {
          t: "Display Time",
          cat: "core",
          d: "Timestamp of request generation.",
        },

        // --- DISPLAY (GPT) / SRA SPECIFIC ---
        ifi: {
          t: "Iframe ID",
          cat: "disp",
          d: "Instance ID of the ad slot iframe.",
        },
        pvsid: {
          t: "Page View ID",
          cat: "disp",
          d: "Session ID linking slots to one page view.",
        },
        iu_parts: {
          t: "Ad Unit Parts",
          cat: "disp",
          d: "Ad unit hierarchy parts (SRA).",
        },
        enc_prev_ius: {
          t: "Prev Ad Units",
          cat: "disp",
          d: "Encoded list of previous ad units on page.",
        },
        prev_iu_szs: {
          t: "Prev Sizes",
          cat: "disp",
          d: "Sizes of previous ad units on page.",
        },
        fluid: { t: "Fluid Slot", cat: "disp", d: "height=Fluid, 0=Fixed." },
        impl: {
          t: "Implementation",
          cat: "disp",
          d: "fifs=Friendly Iframe SafeFrame.",
        },
        sfv: {
          t: "SafeFrame Ver",
          cat: "disp",
          d: "SafeFrame API version (e.g. 1-0-37).",
        },
        tfcd: { t: "Child Directed", cat: "priv", d: "1=COPPA enabled." },
        npa: { t: "Non-Personal", cat: "priv", d: "1=GDPR/CCPA privacy mode." },
        adxs: {
          t: "Slot X Coords",
          cat: "disp",
          d: "X-position of slots on page.",
        },
        adys: {
          t: "Slot Y Coords",
          cat: "disp",
          d: "Y-position of slots on page.",
        },
        psz: {
          t: "Page/Player Size",
          cat: "disp",
          d: "Dimensions of the page/container.",
        },
        msz: {
          t: "Max Size",
          cat: "disp",
          d: "Max available size for the slot.",
        },
        ohw: {
          t: "Overhead Width",
          cat: "disp",
          d: "Space occupied by other elements.",
        },
        fws: {
          t: "Font Web Signals",
          cat: "disp",
          d: "Internal rendering signal.",
        },
        abxe: { t: "AdBlock Exp", cat: "disp", d: "Internal experiment." },

        // --- DEVICE / TELEMETRY (Client Signals) ---
        biw: {
          t: "Browser Width",
          cat: "dev",
          d: "Inner width of browser window.",
        },
        bih: {
          t: "Browser Height",
          cat: "dev",
          d: "Inner height of browser window.",
        },
        u_w: { t: "Screen Width", cat: "dev", d: "Device screen width." },
        u_h: { t: "Screen Height", cat: "dev", d: "Device screen height." },
        u_tz: { t: "Timezone", cat: "dev", d: "Offset from UTC (minutes)." },
        u_his: { t: "History Len", cat: "dev", d: "Browser history length." },
        uach: {
          t: "UA Client Hints",
          cat: "dev",
          d: "Base64 encoded Browser/Platform details.",
        },
        vis: {
          t: "Visibility",
          cat: "dev",
          d: "1=Visible, 2=Hidden, 4=Prerender.",
        },
        scr_x: { t: "Screen X", cat: "dev", d: "Screen X position." },
        scr_y: { t: "Screen Y", cat: "dev", d: "Screen Y position." },

        // --- TARGETING / IDENTITY ---
        cust_params: { t: "Custom Params", cat: "core", d: "Key-values." },
        scp: { t: "Slot Params", cat: "core", d: "Slot-level key-values." },
        ppid: { t: "PPID", cat: "dai", d: "Publisher Provided ID." },
        gdpr: { t: "GDPR", cat: "priv", d: "1=GDPR applies." },
        gdpr_consent: { t: "GDPR String", cat: "priv", d: "TC String." },
        addtl_consent: {
          t: "Google Consent",
          cat: "priv",
          d: "Google Additional Consent string.",
        },
        cookie: { t: "Cookie", cat: "dai", d: "Doubleclick Cookie hash." },
        gpic: { t: "Google Pic", cat: "dai", d: "Google Paid ID Cookie." },

        // --- VIDEO SPECIFIC (Retained) ---
        ad_rule: { t: "Ad Rule", cat: "pod", d: "1=VMAP." },
        pod: { t: "Pod #", cat: "pod", d: "Break sequence." },
        vpos: { t: "Video Pos", cat: "pod", d: "preroll/midroll." },
        min_ad_duration: { t: "Min Dur", cat: "pod", d: "Min ad length." },
        max_ad_duration: { t: "Max Dur", cat: "pod", d: "Max ad length." },
        vad_type: { t: "Ad Type", cat: "core", d: "linear/nonlinear." },
      };

      function parseUrl() {
        const input = document.getElementById("urlInput").value.trim();
        const resultsArea = document.getElementById("resultsArea");

        if (!input) {
          return;
        }

        try {
          // Extraction Logic
          let urlToParse = input.match(/https?:\/\/[^\s"']+/)
            ? input.match(/https?:\/\/[^\s"']+/)[0]
            : input;
          urlToParse = urlToParse.replace(/&amp;/g, "&"); // Fix copy-paste HTML entities

          let queryString = urlToParse.includes("?")
            ? urlToParse.split("?")[1]
            : urlToParse;
          const params = new URLSearchParams(queryString);
          const entries = [];

          for (const [key, value] of params.entries()) {
            entries.push({ key, value });
          }

          if (entries.length === 0) {
            resultsArea.innerHTML =
              '<div class="empty-state">No parameters found.</div>';
            return;
          }

          let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="col-param">Parameter</th>
                            <th class="col-val">Value</th>
                            <th class="col-desc">Description</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

          entries.forEach((item) => {
            let key = item.key;
            let def = paramDict[key];

            // Fallback for unknown
            if (!def) def = { t: "Unknown", cat: "misc", d: "" };

            // Processing Values
            let valDisplay = escapeHtml(item.value);

            // 1. Cust Params Decoding
            if (key === "cust_params" || key === "scp") {
              valDisplay = formatCustParams(item.value);
            }
            // 2. UACH (User Agent Client Hints) Base64 Decoding
            else if (key === "uach") {
              valDisplay = formatBase64Json(item.value);
            }
            // 3. Standard Decoding
            else {
              try {
                valDisplay = decodeURIComponent(valDisplay);
              } catch (e) {}
            }

            // Badges
            let bClass = "b-priv";
            if (def.cat === "core") bClass = "b-core";
            if (def.cat === "pod") bClass = "b-pod";
            if (def.cat === "dai") bClass = "b-dai";
            if (def.cat === "disp") bClass = "b-disp"; // New Display badge
            if (def.cat === "dev") bClass = "b-dev"; // New Device badge

            // Row content
            html += `
                    <tr>
                        <td class="col-param">${key}</td>
                        <td class="col-val">${valDisplay}</td>
                        <td class="col-desc">
                            <div class="desc-row">
                                <span class="badge ${bClass}">${def.cat === "misc" ? "?" : def.cat}</span>
                                <span class="desc-title">${def.t}:</span>
                                <span class="desc-text">${def.d}</span>
                            </div>
                        </td>
                    </tr>
                `;
          });

          html += `</tbody></table>`;
          resultsArea.innerHTML = html;
        } catch (e) {
          resultsArea.innerHTML = `<div class="empty-state">Error: ${e.message}</div>`;
        }
      }

      // Helper: Cust Params Table
      function formatCustParams(str) {
        try {
          const dec = decodeURIComponent(str);
          const pairs = dec.split("&");
          if (pairs.length === 0) return dec;
          let sub = `<table class="sub-table">`;
          pairs.forEach((p) => {
            const parts = p.split("=");
            sub += `<tr><td class="key">${escapeHtml(parts[0])}</td><td>${escapeHtml(parts.slice(1).join("="))}</td></tr>`;
          });
          return sub + `</table>`;
        } catch (e) {
          return escapeHtml(str);
        }
      }

      // Helper: Base64 JSON Decoder (for uach)
      function formatBase64Json(str) {
        try {
          // Decode Base64
          const jsonStr = atob(str);
          // Parse JSON to format it nicely
          const jsonObj = JSON.parse(jsonStr);

          // Build a mini table for the JSON object
          let sub = `<table class="sub-table">`;
          for (const [k, v] of Object.entries(jsonObj)) {
            let displayVal = v;
            // Handle nested arrays (like full_version_list)
            if (typeof v === "object") displayVal = JSON.stringify(v);
            sub += `<tr><td class="key">${escapeHtml(k)}</td><td>${escapeHtml(displayVal)}</td></tr>`;
          }
          return sub + `</table>`;
        } catch (e) {
          // If decode fails, just return original
          return escapeHtml(str);
        }
      }

      function escapeHtml(t) {
        if (!t) return t;
        return String(t)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }
    </script>
  </body>
</html>
